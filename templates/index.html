<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Parser - Modern Interface</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --success: #10b981;
            --success-light: #6ee7b7;
            --error: #ef4444;
            --error-light: #fca5a5;
            --warning: #f59e0b;
            --bg-primary: #fafbfc;
            --bg-secondary: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            gap: 2rem;
        }

        .header {
            text-align: center;
            max-width: 600px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .main-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
            width: 100%;
            max-width: 700px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card-content {
            padding: 2rem;
        }

        /* Upload Area */
        .upload-section {
            margin-bottom: 2rem;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .upload-area:hover {
            border-color: var(--primary-light);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .upload-area:hover::before {
            left: 100%;
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            transition: transform 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }

        .file-input {
            display: none;
        }

        .browse-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .browse-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .browse-btn:active {
            transform: translateY(0);
        }

        /* File Display */
        .file-display {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }

        .btn-remove {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-remove:hover {
            background: #fecaca;
            transform: scale(1.05);
        }

        /* Process Section */
        .process-section {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
        }

        .process-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .option-card {
            background: white;
            border-radius: var(--radius-md);
            padding: 1.25rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            position: relative;
        }

        .option-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .option-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        }

        .option-card.selected::before {
            content: '‚úì';
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .option-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .option-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .option-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 0.75rem;
        }

        .option-features {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .feature-tag {
            background: #f1f5f9;
            color: #475569;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .option-card.selected .feature-tag {
            background: #ddd6fe;
            color: #5b21b6;
        }

        .option-time {
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .process-actions {
            text-align: center;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .process-info {
            color: var(--text-muted);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Status Section */
        .status-section {
            margin: 1.5rem 0;
        }

        .status-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .status-card.processing {
            border-color: var(--primary-light);
            background: linear-gradient(135deg, #f8faff 0%, #f0f4ff 100%);
        }

        .status-card.success {
            border-color: var(--success-light);
            background: linear-gradient(135deg, #f0fdf9 0%, #ecfdf5 100%);
        }

        .status-card.error {
            border-color: var(--error-light);
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .status-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .status-card.processing .status-icon {
            background: var(--primary);
            color: white;
            animation: pulse 2s infinite;
        }

        .status-card.success .status-icon {
            background: var(--success);
            color: white;
        }

        .status-card.error .status-icon {
            background: var(--error);
            color: white;
        }

        .status-text {
            flex: 1;
        }

        .status-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .status-message {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* JSON Section */
        .json-section {
            margin-top: 2rem;
        }

        .json-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .json-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .json-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
            color: var(--text-primary);
        }

        .json-container {
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .json-search-controls {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            background: #f8fafc;
            align-items: center;
        }

        .search-input-group {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            min-width: 200px;
        }

        .search-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            min-width: 100px;
        }

        .search-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .search-replace-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .search-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            padding: 0 0.5rem;
            white-space: nowrap;
        }

        .json-display, .json-editor {
            background: #fafbfc;
            color: var(--text-primary);
            padding: 1.5rem;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            overflow-x: auto;
            max-height: 400px;
            white-space: pre-wrap;
            word-break: break-word;
            margin: 0;
            border: none;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            resize: vertical;
        }

        .json-editor {
            background: white;
            border: 2px solid var(--primary);
            min-height: 300px;
        }

        .validation-message {
            margin-top: 1rem;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .validation-message.success {
            background: linear-gradient(135deg, #f0fdf9 0%, #ecfdf5 100%);
            border: 1px solid var(--success-light);
            color: #166534;
        }

        .validation-message.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid var(--error-light);
            color: #dc2626;
        }

        .download-section {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app {
                padding: 1rem 0.5rem;
                gap: 1.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card-content {
                padding: 1.5rem;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            .process-options {
                grid-template-columns: 1fr;
            }

            .json-controls {
                width: 100%;
                justify-content: stretch;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }

            .download-section {
                flex-direction: column;
            }

            .download-section .btn {
                width: 100%;
                justify-content: center;
            }

            .json-search-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input-group {
                min-width: auto;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .slide-down {
            animation: slideDown 0.3s ease-out;
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--error);
            color: white;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>PDF Parser</h1>
            <p>Transform your PDF documents into structured JSON data with our intelligent parsing engine</p>
        </div>
        
        <div class="main-card">
            <div class="card-content">
                <div class="upload-section">
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">üìÑ</div>
                        <div class="upload-text">Drop your PDF file here</div>
                        <div class="upload-hint">or click to browse from your device</div>
                        <button class="browse-btn" type="button">Choose File</button>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf">
                </div>

                <div id="fileDisplay" class="file-display hidden">
                    <div class="file-icon">üìÑ</div>
                    <div class="file-info">
                        <div class="file-name" id="fileName"></div>
                        <div class="file-size" id="fileSize"></div>
                    </div>
                    <div class="file-actions">
                        <button id="removeFileBtn" class="btn-icon btn-remove" title="Remove file">
                            <span>üóëÔ∏è</span>
                        </button>
                    </div>
                </div>

                 <div id="processSection" class="process-section hidden">
                    <div class="process-options">
                        <div class="option-card" data-type="basic">
                            <div class="option-icon">üìù</div>
                            <div class="option-content">
                                <div class="option-title">Basic Text Extraction</div>
                                <div class="option-description">Clean text content, paragraphs, and basic formatting</div>
                                <div class="option-features">
                                    <span class="feature-tag">‚úì Text content</span>
                                    <span class="feature-tag">‚úì Paragraphs</span>
                                    <span class="feature-tag">‚úì Basic structure</span>
                                </div>
                                <div class="option-time">‚ö° ~10-15 seconds</div>
                            </div>
                        </div>
                        <div class="option-card" data-type="advanced">
                            <div class="option-icon">üß†</div>
                            <div class="option-content">
                                <div class="option-title">Advanced Analysis</div>
                                <div class="option-description">Complete document analysis with tables, metadata, and layout</div>
                                <div class="option-features">
                                    <span class="feature-tag">‚úì Everything in Basic</span>
                                    <span class="feature-tag">‚úì Tables & Charts</span>
                                    <span class="feature-tag">‚úì Document metadata</span>
                                    <span class="feature-tag">‚úì Layout analysis</span>
                                </div>
                                <div class="option-time">‚è±Ô∏è ~20-45 seconds</div>
                            </div>
                        </div>
                    </div>
                    <div class="process-actions">
                        <button id="processBtn" class="btn btn-primary btn-large">
                            <span>‚ö°</span>
                            Process PDF
                        </button>
                        
                        <div class="process-info">
                            <span>‚è±Ô∏è Estimated time: 10-30 seconds</span>
                        </div>
                    </div>
                </div>

                <div id="statusSection" class="status-section hidden">
                    <div id="statusCard" class="status-card">
                        <div class="status-content">
                            <div class="status-icon" id="statusIcon">‚è≥</div>
                            <div class="status-text">
                                <div class="status-title" id="statusTitle">Processing</div>
                                <div class="status-message" id="statusMessage">Uploading your file...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="jsonSection" class="json-section hidden">
                    <div class="json-header">
                        <div class="json-title">
                            <span>üìä</span>
                            Parsed Data
                        </div>
                        <div class="json-controls">
                            <button id="editJsonBtn" class="btn btn-secondary">
                                <span>‚úèÔ∏è</span>Edit
                            </button>
                            <button id="saveJsonBtn" class="btn btn-success hidden">
                                <span>üíæ</span>Save
                            </button>
                            <button id="cancelEditBtn" class="btn btn-secondary hidden">
                                <span>‚ùå</span>Cancel
                            </button>
                        </div>
                    </div>

                    <div class="json-container">
                        <div class="json-search-controls hidden" id="jsonSearchControls">
                            <div class="search-input-group">
                                <input type="text" id="searchInput" class="search-input" placeholder="Search...">
                                <input type="text" id="replaceInput" class="search-input" placeholder="Replace with...">
                            </div>
                            <div class="search-replace-buttons">
                                <button class="btn btn-secondary" id="prevMatchBtn" title="Previous (Shift+Enter)">‚Üë</button>
                                <button class="btn btn-secondary" id="nextMatchBtn" title="Next (Enter)">‚Üì</button>
                                <button class="btn btn-primary" id="replaceBtn">Replace</button>
                                <button class="btn btn-primary" id="replaceAllBtn">Replace All</button>
                            </div>
                            <div class="search-count" id="searchCount"></div>
                        </div>
                        <div id="jsonDisplay" class="json-display"></div>
                        <textarea id="jsonEditor" class="json-editor hidden" placeholder="Edit your JSON data here..."></textarea>
                    </div>
                    
                    <div id="validationMessage" class="validation-message hidden"></div>
                    
                    <div class="download-section">
                        <button id="downloadJsonBtn" class="btn btn-primary">
                            <span>üì•</span>Download JSON
                        </button>
                        <button id="copyJsonBtn" class="btn btn-secondary">
                            <span>üìã</span>Copy JSON
                        </button>
                        <button id="downloadTextBtn" class="btn btn-primary">
                            <span>üìù</span>Download Text
                        </button>
                        <button id="copyTextBtn" class="btn btn-secondary">
                            <span>üìÑ</span>Copy Text
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentJsonData = null;
        let currentFilename = '';
        let currentFile = null;
        let isEditing = false;
        let selectedProcessingType = 'basic';
        let currentSearchMatches = [];
        let currentMatchIndex = -1;
        let originalJsonValue = '';

        // DOM elements
        const uploadArea = document.querySelector('.upload-area');
        const fileInput = document.getElementById('fileInput');
        const fileDisplay = document.getElementById('fileDisplay');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFileBtn = document.getElementById('removeFileBtn');
        const processSection = document.getElementById('processSection');
        const processBtn = document.getElementById('processBtn');
        const statusSection = document.getElementById('statusSection');
        const statusCard = document.getElementById('statusCard');
        const statusIcon = document.getElementById('statusIcon');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const jsonSection = document.getElementById('jsonSection');
        const jsonDisplay = document.getElementById('jsonDisplay');
        const jsonEditor = document.getElementById('jsonEditor');
        const downloadJsonBtn = document.getElementById('downloadJsonBtn');
        const copyJsonBtn = document.getElementById('copyJsonBtn');
        const downloadTextBtn = document.getElementById('downloadTextBtn');
        const copyTextBtn = document.getElementById('copyTextBtn');
        const editJsonBtn = document.getElementById('editJsonBtn');
        const saveJsonBtn = document.getElementById('saveJsonBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const validationMessage = document.getElementById('validationMessage');
        const searchInput = document.getElementById('searchInput');
        const replaceInput = document.getElementById('replaceInput');
        const prevMatchBtn = document.getElementById('prevMatchBtn');
        const nextMatchBtn = document.getElementById('nextMatchBtn');
        const replaceBtn = document.getElementById('replaceBtn');
        const replaceAllBtn = document.getElementById('replaceAllBtn');
        const jsonSearchControls = document.getElementById('jsonSearchControls');
        const searchCount = document.getElementById('searchCount');

          function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        // Show notification
        function showNotification(message, type = 'info') { 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showNotification(message, type = 'info') { 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Handle file upload
        function handleFile(file) {
            if (!file.type.includes('pdf')) {
                showNotification('Please select a PDF file.', 'error');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showNotification('File size must be less than 50MB.', 'error');
                return;
            }

            currentFilename = file.name;
            currentFile = file;
            showFileDisplay(file);
            showProcessSection();
            hideJsonData();
            hideStatus();
        }

        function showFileDisplay(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileDisplay.classList.remove('hidden');
            fileDisplay.classList.add('fade-in');
        }

        function showProcessSection() {
            processSection.classList.remove('hidden');
            processSection.classList.add('fade-in');
            setupProcessingOptions();
        }

        function hideProcessSection() {
            processSection.classList.add('hidden');
        }

        function setupProcessingOptions() {
            const optionCards = document.querySelectorAll('.option-card');
            
            if (optionCards.length > 0) {
                optionCards[0].classList.add('selected');
                selectedProcessingType = optionCards[0].dataset.type || 'basic';
            }
            
            optionCards.forEach((card) => {
                card.addEventListener('click', () => {
                    optionCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedProcessingType = card.dataset.type || 'basic';
                    updateProcessButtonText();
                });
            });
            
            updateProcessButtonText();
        }

        function updateProcessButtonText() {
            const isAdvanced = selectedProcessingType === 'advanced';
            processBtn.innerHTML = isAdvanced 
                ? '<span>üß†</span>Start Advanced Analysis'
                : '<span>üìù</span>Extract Text & Structure';
        }

        function removeFile() {
            currentFile = null;
            currentFilename = '';
            fileDisplay.classList.add('hidden');
            hideProcessSection();
            hideJsonData();
            hideStatus();
            fileInput.value = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showStatus(title, message, type = 'processing', icon = '‚è≥') {
            statusSection.classList.remove('hidden');
            statusSection.classList.add('fade-in');
            
            statusCard.className = `status-card ${type}`;
            statusIcon.textContent = icon;
            statusTitle.textContent = title;
            statusMessage.textContent = message;
        }

        function hideStatus() {
            statusSection.classList.add('hidden');
        }

        function showJsonData(data) {
            currentJsonData = data;
            jsonDisplay.textContent = JSON.stringify(data, null, 2);
            jsonSection.classList.remove('hidden');
            jsonSection.classList.add('slide-down');
            exitEditMode();
        }

        function hideJsonData() {
            jsonSection.classList.add('hidden');
            currentJsonData = null;
            exitEditMode();
        }

        // JSON editing functionality
        function enterEditMode() {
            isEditing = true;
            originalJsonValue = JSON.stringify(currentJsonData, null, 2);
            jsonEditor.value = originalJsonValue;
            jsonDisplay.classList.add('hidden');
            jsonEditor.classList.remove('hidden');
            editJsonBtn.classList.add('hidden');
            saveJsonBtn.classList.remove('hidden');
            cancelEditBtn.classList.remove('hidden');
            showSearchControls();
            hideValidationMessage();
            jsonEditor.focus();
            
            // Reset search state when entering edit mode
            clearSearch();
        }

        function exitEditMode() {
            isEditing = false;
            jsonEditor.classList.add('hidden');
            jsonDisplay.classList.remove('hidden');
            saveJsonBtn.classList.add('hidden');
            cancelEditBtn.classList.add('hidden');
            editJsonBtn.classList.remove('hidden');
            hideSearchControls();
            hideValidationMessage();
            clearSearch();
        }

        function saveJsonChanges() {
            try {
                const editedText = jsonEditor.value;
                const parsedData = JSON.parse(editedText);
                
                currentJsonData = parsedData;
                jsonDisplay.textContent = JSON.stringify(parsedData, null, 2);
                
                showValidationMessage('‚úÖ JSON updated successfully!', 'success');
                exitEditMode();
                
            } catch (error) {
                showValidationMessage(`‚ùå Invalid JSON: ${error.message}`, 'error');
            }
        }

        function cancelEdit() {
            jsonEditor.value = originalJsonValue;
            exitEditMode();
        }

        function showValidationMessage(message, type = 'error') {
            validationMessage.innerHTML = message;
            validationMessage.className = `validation-message ${type}`;
            validationMessage.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    hideValidationMessage();
                }, 3000);
            }
        }

        function hideValidationMessage() {
            validationMessage.classList.add('hidden');
        }

        // Search and Replace Functionality
        function showSearchControls() {
            jsonSearchControls.classList.remove('hidden');
        }

        function hideSearchControls() {
            jsonSearchControls.classList.add('hidden');
            clearSearch();
        }

        function clearSearch() {
            searchInput.value = '';
            replaceInput.value = '';
            currentSearchMatches = [];
            currentMatchIndex = -1;
            updateSearchCount();
            updateSearchButtons();
        }

        function updateSearchCount() {
            if (currentSearchMatches.length > 0) {
                searchCount.textContent = `${currentMatchIndex + 1} of ${currentSearchMatches.length}`;
            } else if (searchInput.value.trim()) {
                searchCount.textContent = 'No matches';
            } else {
                searchCount.textContent = '';
            }
        }

        function performSearch() {
            const searchTerm = searchInput.value.trim();
            const text = jsonEditor.value;
            currentSearchMatches = [];
            
            if (searchTerm) {
                let match;
                const regex = new RegExp(escapeRegExp(searchTerm), 'gi');
                while ((match = regex.exec(text)) !== null) {
                    currentSearchMatches.push({
                        start: match.index,
                        end: match.index + match[0].length,
                        text: match[0]
                    });
                    
                    if (match.index === regex.lastIndex) {
                        regex.lastIndex++;
                    }
                }
                
                // Find the first match at or after current cursor position
                const currentPos = jsonEditor.selectionStart;
                let foundIndex = currentSearchMatches.findIndex(match => match.start >= currentPos);
                if (foundIndex === -1 && currentSearchMatches.length > 0) {
                    foundIndex = 0;
                }
                currentMatchIndex = foundIndex !== -1 ? foundIndex : -1;
            } else {
                currentMatchIndex = -1;
            }
            
            updateSearchCount();
            updateSearchButtons();
        }

        function updateSearchButtons() {
            const hasMatches = currentSearchMatches.length > 0;
            prevMatchBtn.disabled = !hasMatches;
            nextMatchBtn.disabled = !hasMatches;
            replaceBtn.disabled = !hasMatches || currentMatchIndex === -1;
            replaceAllBtn.disabled = !hasMatches;
        }

        function highlightMatch() {
            if (currentMatchIndex >= 0 && currentMatchIndex < currentSearchMatches.length) {
                const match = currentSearchMatches[currentMatchIndex];
                jsonEditor.focus();
                jsonEditor.setSelectionRange(match.start, match.end);
                scrollToMatch(match);
            }
        }
        // function scrollToMatch(match) {
        //     const textBeforeMatch = jsonEditor.value.substring(0, match.start);
        //     const lines = textBeforeMatch.split('\n');
        //     const lineNumber = lines.length - 1;
            
        //     const computedStyle = window.getComputedStyle(jsonEditor);
        //     const lineHeight = parseFloat(computedStyle.lineHeight) || 20;
        //     const paddingTop = parseFloat(computedStyle.paddingTop) || 0;
            
        //     const linePixelPosition = lineNumber * lineHeight;
        //     const viewportHeight = jsonEditor.clientHeight;
        //     const scrollPosition = linePixelPosition - (viewportHeight / 2) + paddingTop;
            
        //     const maxScroll = jsonEditor.scrollHeight - jsonEditor.clientHeight;
        //     const finalScrollPosition = Math.max(0, Math.min(maxScroll, scrollPosition));
            
        //     jsonEditor.scrollTop = finalScrollPosition;
        // }
        /**
 * Scroll the current match into the visible area of the textarea
 * Works even with soft-wrapped lines or very long text.
 */function scrollToMatch(match) {
  /* 1. Focus + select */
  jsonEditor.focus();
  jsonEditor.setSelectionRange(match.start, match.end);

  /* 2. Force reflow once */
  void jsonEditor.offsetHeight;

  /* 3. Single hidden clone for exact scroll height */
  const clone = document.createElement('textarea');
  clone.style.cssText = `
    position:absolute; left:-9999px; top:0;
    font: ${getComputedStyle(jsonEditor).font};
    width: ${jsonEditor.clientWidth}px;
    height:auto; overflow:hidden; white-space:pre-wrap;
  `;
  clone.value = jsonEditor.value.substring(0, match.start);
  document.body.appendChild(clone);

  const caretTop = clone.scrollHeight;
  const lineHeight = clone.scrollHeight / (clone.value.split('\n').length || 1);
  document.body.removeChild(clone);

  /* 4. Snap caret to the *nearest* edge instead of center */
  const scrollTarget = caretTop - lineHeight / 2; // top of the line
  jsonEditor.scrollTop = Math.max(0, scrollTarget);
}

        function findNext() {
            if (currentSearchMatches.length > 0) {
                currentMatchIndex = (currentMatchIndex + 1) % currentSearchMatches.length;
                updateSearchCount();
                highlightMatch();
            }
        }

        function findPrev() {
            if (currentSearchMatches.length > 0) {
                currentMatchIndex = (currentMatchIndex - 1 + currentSearchMatches.length) % currentSearchMatches.length;
                updateSearchCount();
                highlightMatch();
            }
        }

        function replaceCurrentMatch() {
            if (currentMatchIndex >= 0 && currentMatchIndex < currentSearchMatches.length) {
                const match = currentSearchMatches[currentMatchIndex];
                const replacementText = replaceInput.value;
                const text = jsonEditor.value;
                
                const newText = text.substring(0, match.start) + replacementText + text.substring(match.end);
                jsonEditor.value = newText;
                
                const lengthDiff = replacementText.length - (match.end - match.start);
                
                // Update subsequent match positions
                for (let i = currentMatchIndex + 1; i < currentSearchMatches.length; i++) {
                    currentSearchMatches[i].start += lengthDiff;
                    currentSearchMatches[i].end += lengthDiff;
                }
                
                // Remove the replaced match
                currentSearchMatches.splice(currentMatchIndex, 1);
                
                // Adjust current index
                if (currentMatchIndex >= currentSearchMatches.length && currentSearchMatches.length > 0) {
                    currentMatchIndex = currentSearchMatches.length - 1;
                } else if (currentSearchMatches.length === 0) {
                    currentMatchIndex = -1;
                }
                
                // Position cursor after replacement
                const newCursorPos = match.start + replacementText.length;
                jsonEditor.setSelectionRange(newCursorPos, newCursorPos);
                
                updateSearchCount();
                updateSearchButtons();
                
                if (currentSearchMatches.length > 0 && currentMatchIndex >= 0) {
                    highlightMatch();
                }
            }
        }

        function replaceAllMatches() {
    const searchTerm = searchInput.value.trim();
    const replacementText = replaceInput.value;

    if (!searchTerm) return;

    // Use .replace once ‚Äì no manual loop
    const newText = jsonEditor.value.replace(
        new RegExp(escapeRegExp(searchTerm), 'g'),
        replacementText
    );

    // Count how many replacements happened
    const replacedCount = (jsonEditor.value.match(new RegExp(escapeRegExp(searchTerm), 'g')) || []).length;

    jsonEditor.value = newText;

    // Re-scan matches
    performSearch(false);

    showNotification(`Replaced ${replacedCount} occurrence${replacedCount === 1 ? '' : 's'}`, 'success');
}

        // Event listeners for search functionality
        searchInput.addEventListener('input', performSearch);
        
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (e.shiftKey) {
                    findPrev();
                } else {
                    findNext();
                }
            }
        });

        replaceInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                replaceCurrentMatch();
            }
        });

        prevMatchBtn.addEventListener('click', findPrev);
        nextMatchBtn.addEventListener('click', findNext);
        replaceBtn.addEventListener('click', replaceCurrentMatch);
        replaceAllBtn.addEventListener('click', replaceAllMatches);

        // Main event listeners
        removeFileBtn.addEventListener('click', removeFile);
        processBtn.addEventListener('click', () => {
            if (currentFile) {
                uploadFile(currentFile);
            }
        });
        editJsonBtn.addEventListener('click', enterEditMode);
        saveJsonBtn.addEventListener('click', saveJsonChanges);
        cancelEditBtn.addEventListener('click', cancelEdit);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (isEditing) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    searchInput.focus();
                    searchInput.select();
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                    e.preventDefault();
                    if (e.shiftKey) {
                        findPrev();
                    } else {
                        findNext();
                    }
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveJsonChanges();
                }
                
                if (e.key === 'Escape') {
                    if (!jsonSearchControls.classList.contains('hidden')) {
                        searchInput.blur();
                        replaceInput.blur();
                        jsonEditor.focus();
                    } else {
                        cancelEdit();
                    }
                }
            }
        });

        // Download and Copy functionality
        downloadJsonBtn.addEventListener('click', () => {
            if (currentJsonData) {
                downloadJson(currentJsonData, `${currentFilename.replace('.pdf', '')}_parsed.json`);
            }
        });

        copyJsonBtn.addEventListener('click', () => {
            if (currentJsonData) {
                copyToClipboard(JSON.stringify(currentJsonData, null, 2), 'JSON data copied to clipboard!');
            }
        });

        downloadTextBtn.addEventListener('click', () => {
            if (currentJsonData) {
                const textContent = extractTextFromJson(currentJsonData);
                downloadText(textContent, `${currentFilename.replace('.pdf', '')}_text.txt`);
            }
        });

        copyTextBtn.addEventListener('click', () => {
            if (currentJsonData) {
                const textContent = extractTextFromJson(currentJsonData);
                copyToClipboard(textContent, 'Text content copied to clipboard!');
            }
        });

        function downloadJson(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadText(text, filename) {
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function copyToClipboard(text, successMessage = 'Copied to clipboard!') {
            try {
                await navigator.clipboard.writeText(text);
                showNotification(successMessage, 'success');
            } catch (err) {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification(successMessage, 'success');
                } catch (fallbackErr) {
                    console.error('Failed to copy text: ', fallbackErr);
                    showNotification('Failed to copy to clipboard', 'error');
                }
            }
        }

        function extractTextFromJson(data) {
            let textContent = '';
            const elements = data?.data?.elements || data?.elements || [];
            
            elements.forEach(element => {
                if (element.text && element.text.trim()) {
                    textContent += element.text + '\n';
                }
            });
            
            return textContent || 'No text content found in the parsed data.';
        }

        // Mock mode for testing
        const USE_MOCK = false; // Set to false for production

        async function uploadFile(file) {
            if (USE_MOCK) {
                hideProcessSection();
                hideJsonData();
                showStatus('Processing', `Simulating PDF parsing with ${selectedProcessingType}...`, 'processing', '‚ö°');
                setTimeout(() => {
                    const mockElements = [];
                    for (let i = 1; i <= 50; i++) {
                        mockElements.push({
                            text: `K.Ban is known to me as a patient since 2014. He has had multiple problems over the last seven years including Hypertension ,Anxiety,IBS, Hiatal Hernia and Migraines. He is on multiple medications including multiple psychiatric medications and two medications for his blood pressure. He has multiple Psychiatric diagnosis mainly PTSD,Depression and Anxiety Disorder.`,
                            type: i % 3 === 0 ? 'table' : (i % 2 === 0 ? 'paragraph' : 'title'),
                            id: i,
                            page: Math.floor((i-1)/10)+1
                        });
                    }
                    const mockData = {
                        data: {
                            elements: mockElements,
                            metadata: { 
                                author: 'Mock Author', 
                                pages: 5, 
                                created: '2025-08-06', 
                                title: 'Test PDF for Search Functionality' 
                            }
                        }
                    };
                    showStatus('Complete', 'File processed (mock) successfully!', 'success', '‚úÖ');
                    showJsonData(mockData);
                    showNotification('PDF processed (mock) successfully!', 'success');
                }, 1000);
                return;
            }

            hideProcessSection();
            hideJsonData();
            showStatus('Processing', `Analyzing your PDF with ${selectedProcessingType} parsing...`, 'processing', '‚ö°');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('processing_type', selectedProcessingType);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showStatus('Complete', 'File processed successfully!', 'success', '‚úÖ');
                    showJsonData(result.parsed_data);
                    showNotification('PDF processed successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showStatus('Error', error.message, 'error', '‚ùå');
                showProcessSection();
                showNotification(`Processing failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>